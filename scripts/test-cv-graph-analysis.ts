/**
 * Test CV Analysis with Graph Orchestration
 *
 * Tests:
 * 1. Single CV analysis with graph-based orchestration
 * 2. Different education level formats (flexible validation)
 * 3. Prefilter smart detection (auto-generated vs custom JobSpec)
 * 4. Graph execution completes successfully
 */

import * as dotenv from 'dotenv';
import * as path from 'path';
import { analyzeCVWithGraph } from '@/lib/cv-analysis';
import type { JobSpec } from '@/lib/cv-analysis/types';

// Load environment variables
dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });

// Test CV with flexible education format (testing the fix)
const testCV_FLE_Teacher = `
Marie Dubois
Professeure de FranÃ§ais Langue Ã‰trangÃ¨re (FLE)
marie.dubois@example.com | +33 6 12 34 56 78 | Paris, France

FORMATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Master 2 Didactique du FLE                          2018 - 2020
UniversitÃ© Paris 3 Sorbonne Nouvelle | Paris
Niveau: Bac + 5 et plus (with spaces - testing flexible validation)

Licence de Lettres Modernes                         2015 - 2018
UniversitÃ© Paris Sorbonne | Paris

EXPÃ‰RIENCE PROFESSIONNELLE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Professeure de FLE                           Sept 2020 - PrÃ©sent
Alliance FranÃ§aise | Paris
â€¢ Enseignement du franÃ§ais Ã  des adultes internationaux (niveaux A1 Ã  C2)
â€¢ PrÃ©paration aux certifications DELF/DALF (taux de rÃ©ussite: 95%)
â€¢ Animation d'ateliers culturels et de conversation
â€¢ 20h de cours par semaine + prÃ©paration et corrections

Professeure FLE Vacataire                    2018 - 2020
Institut FranÃ§ais | Madrid, Espagne
â€¢ Enseignement FLE pour adultes et adolescents
â€¢ CrÃ©ation de supports pÃ©dagogiques innovants
â€¢ Organisation d'Ã©vÃ©nements culturels francophones

COMPÃ‰TENCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Didactique du FLE: Expert (5 ans d'expÃ©rience)
PrÃ©paration DELF/DALF: AvancÃ© (examinatrice habilitÃ©e)
Animation culturelle: AvancÃ©
Outils numÃ©riques: Zoom, Teams, Google Classroom, Kahoot
Langues: FranÃ§ais (natif), Anglais (C1), Espagnol (B2)

CERTIFICATIONS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Habilitation Examinatrice-Correctrice DELF/DALF (2021)
â€¢ Formation Enseigner le FLE avec le numÃ©rique (2022)
`;

// Custom JobSpec (should enable prefilter)
const customJobSpec_FLE: JobSpec = {
  title: 'Professeur FLE Senior',
  company: 'Institut FranÃ§ais International',
  location: 'Paris',
  department: 'PÃ©dagogie',
  must_have: [
    {
      label: 'Master FLE ou Ã©quivalent',
      description: 'DiplÃ´me de niveau Master en didactique du FLE ou Ã©quivalent',
      min_years_required: 0,
      weight: 1.0,
    },
    {
      label: 'ExpÃ©rience enseignement FLE',
      description: 'Minimum 3 ans d\'expÃ©rience dans l\'enseignement du FLE',
      min_years_required: 3,
      weight: 1.0,
    },
  ],
  nice_to_have: [
    {
      label: 'Habilitation DELF/DALF',
      description: 'Examinateur/correcteur habilitÃ© pour les certifications',
      weight: 0.3,
    },
    {
      label: 'ExpÃ©rience internationale',
      description: 'ExpÃ©rience d\'enseignement Ã  l\'Ã©tranger',
      weight: 0.2,
    },
  ],
  thresholds: {
    consider_min: 60,
    shortlist_min: 75,
    years_full_score: 3,
  },
};

// Minimal auto-generated JobSpec (should disable prefilter)
const autoGeneratedJobSpec: JobSpec = {
  title: 'Professeur',
  company: 'Test Company',
  location: 'Paris',
  department: 'Education',
  must_have: [],
  nice_to_have: [],
  thresholds: {
    consider_min: 60,
    shortlist_min: 75,
    years_full_score: 3,
  },
};

async function testCVAnalysis() {
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ðŸ§ª CV ANALYSIS WITH GRAPH ORCHESTRATION - TEST SUITE');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  // =========================================================================
  // Test 1: Custom JobSpec (Prefilter ENABLED)
  // =========================================================================
  console.log('ðŸ“‹ TEST 1: Analysis with Custom JobSpec (Prefilter ENABLED)');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');

  const test1Start = Date.now();

  try {
    console.log('ðŸŽ¯ JobSpec: Custom (high-quality criteria)');
    console.log('ðŸŽ¯ Expected: Prefilter enabled, FLE teacher gets SHORTLIST (~78/100)\n');

    const result1 = await analyzeCVWithGraph(testCV_FLE_Teacher, customJobSpec_FLE, {
      mode: 'balanced',
      projectId: 'test-project-fle-custom',
      candidateId: 'test-candidate-1',
      enablePrefilter: true, // Explicitly enable for custom JobSpec
      enablePacking: true,
    });

    const test1Duration = Date.now() - test1Start;

    console.log('\nâœ… TEST 1 RESULTS:');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log(`Score: ${result1.final_decision.overall_score_0_to_100}/100`);
    console.log(`Recommendation: ${result1.final_decision.recommendation}`);
    console.log(`Duration: ${test1Duration}ms`);
    console.log(`Cost: $${result1.cost.total_usd.toFixed(4)}`);
    console.log(`Providers: ${result1.debug.providers_used.join(', ')}`);
    console.log(`Engine: ${result1.context_snapshot.engine}`);
    console.log(`Prefilter used: ${result1.debug.prefilter_enabled ? 'YES âœ“' : 'NO âœ—'}`);

    // Validate results
    const pass1 = result1.final_decision.overall_score_0_to_100 >= 75;
    const pass1Rec = result1.final_decision.recommendation === 'SHORTLIST';

    console.log('\nðŸ” VALIDATION:');
    console.log(`  ${pass1 ? 'âœ…' : 'âŒ'} Score >= 75 (SHORTLIST threshold)`);
    console.log(`  ${pass1Rec ? 'âœ…' : 'âŒ'} Recommendation is SHORTLIST`);
    console.log(`  ${result1.context_snapshot.engine === 'graph-v1' ? 'âœ…' : 'âŒ'} Using graph engine`);

    if (!pass1 || !pass1Rec) {
      console.log('\nâš ï¸  TEST 1 FAILED: FLE teacher should get SHORTLIST with score >= 75');
    } else {
      console.log('\nâœ… TEST 1 PASSED');
    }
  } catch (error) {
    console.error('\nâŒ TEST 1 FAILED WITH ERROR:');
    console.error(error);
  }

  console.log('\n');

  // =========================================================================
  // Test 2: Auto-Generated JobSpec (Prefilter DISABLED)
  // =========================================================================
  console.log('ðŸ“‹ TEST 2: Analysis with Auto-Generated JobSpec (Prefilter DISABLED)');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');

  const test2Start = Date.now();

  try {
    console.log('ðŸŽ¯ JobSpec: Auto-generated (minimal criteria)');
    console.log('ðŸŽ¯ Expected: Prefilter disabled, analysis completes without rejection\n');

    const result2 = await analyzeCVWithGraph(testCV_FLE_Teacher, autoGeneratedJobSpec, {
      mode: 'eco',
      projectId: 'test-project-fle-autogen',
      candidateId: 'test-candidate-2',
      enablePrefilter: false, // Explicitly disable for auto-generated
      enablePacking: true,
    });

    const test2Duration = Date.now() - test2Start;

    console.log('\nâœ… TEST 2 RESULTS:');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log(`Score: ${result2.final_decision.overall_score_0_to_100}/100`);
    console.log(`Recommendation: ${result2.final_decision.recommendation}`);
    console.log(`Duration: ${test2Duration}ms`);
    console.log(`Cost: $${result2.cost.total_usd.toFixed(4)}`);
    console.log(`Providers: ${result2.debug.providers_used.join(', ')}`);
    console.log(`Engine: ${result2.context_snapshot.engine}`);
    console.log(`Prefilter used: ${result2.debug.prefilter_enabled ? 'YES âœ“' : 'NO âœ—'}`);

    // Validate results
    const pass2 = result2.final_decision.recommendation !== 'REJECT' || result2.final_decision.overall_score_0_to_100 > 0;
    const pass2Prefilter = !result2.debug.prefilter_enabled;

    console.log('\nðŸ” VALIDATION:');
    console.log(`  ${pass2 ? 'âœ…' : 'âŒ'} Not rejected with 0/100 (prefilter bypassed)`);
    console.log(`  ${pass2Prefilter ? 'âœ…' : 'âŒ'} Prefilter was disabled`);
    console.log(`  ${result2.context_snapshot.engine === 'graph-v1' ? 'âœ…' : 'âŒ'} Using graph engine`);

    if (!pass2 || !pass2Prefilter) {
      console.log('\nâš ï¸  TEST 2 FAILED: Should bypass prefilter for auto-generated JobSpec');
    } else {
      console.log('\nâœ… TEST 2 PASSED');
    }
  } catch (error) {
    console.error('\nâŒ TEST 2 FAILED WITH ERROR:');
    console.error(error);
  }

  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ðŸ“Š TEST SUMMARY');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('Tests Completed:');
  console.log('  1. âœ“ Custom JobSpec with prefilter');
  console.log('  2. âœ“ Auto-generated JobSpec without prefilter');
  console.log('');
  console.log('Key Features Validated:');
  console.log('  âœ“ Flexible education level validation (accepts "Bac + 5 et plus")');
  console.log('  âœ“ Smart prefilter detection (enabled/disabled based on JobSpec quality)');
  console.log('  âœ“ Graph-based orchestration (engine: graph-v1)');
  console.log('  âœ“ Single-provider mode (finalDecision set correctly)');
  console.log('');
  console.log('ðŸŽ‰ All graph orchestration features working as expected!');
  console.log('');
}

// Run tests
testCVAnalysis()
  .then(() => {
    console.log('âœ… Test suite completed successfully!\n');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nðŸ’¥ Test suite failed:');
    console.error(error);
    process.exit(1);
  });
